<!DOCTYPE html>
<html xmlns:th="[http://www.thymeleaf.org](http://www.thymeleaf.org)">
<head>
    <meta charset="UTF-8">
    <title>Appointment Form</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>.error{color:#ef4444;font-size:0.85em;margin-top:4px;}</style>
</head>
<body>
<div class="wrap">
    <div class="topbar">
        <a class="back" th:href="@{/appointments}">‚Üê Back</a>
        <div class="hx">
            <div class="pill a">üìÖ</div>
            <h1 th:text="${appointment.id} != null ? 'Edit Appointment' : 'New Appointment'">Form</h1>
        </div>
    </div>
    <div class="card">
        <form class="form" th:action="${appointment.id} != null ? @{/appointments/{id}(id=${appointment.id})} : @{/appointments}" th:object="${appointment}" method="post">
            <div class="row">
                <div>
                    <label>Date *</label>
                    <input type="date" th:field="*{admissionDate}" th:classappend="${#fields.hasErrors('admissionDate')} ? 'is-invalid'">
                    <div class="error" th:if="${#fields.hasErrors('admissionDate')}" th:errors="*{admissionDate}">Error</div>
                </div>
                <div>
                    <label>Status</label>
                    <select th:field="*{status}">
                        <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Patient *</label>
                    <select id="pId" th:field="*{patient}" required onchange="onPatientSelect()" th:classappend="${#fields.hasErrors('patient')} ? 'is-invalid'">
                        <option value="">-- Select Patient --</option>
                        <option th:each="p : ${patients}" th:value="${p.id}" th:text="${p.name}"></option>
                    </select>
                    <div class="error" th:if="${#fields.hasErrors('patient')}" th:errors="*{patient}">Error</div>
                </div>
                <div>
                    <label>Department *</label>
                    <select id="dId" th:field="*{department}" required th:classappend="${#fields.hasErrors('department')} ? 'is-invalid'">
                        <option value="">-- Select Department --</option>
                        <option th:each="d : ${departments}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                    <div class="error" th:if="${#fields.hasErrors('department')}" th:errors="*{department}">Error</div>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Room (Optional)</label>
                    <select id="rId" th:field="*{room}">
                        <option value="">-- No Room --</option>
                        <option th:each="r : ${rooms}" th:value="${r.id}" th:text="${r.number + ' (' + r.hospital.name + ')'}"></option>
                    </select>
                </div>
                <div></div>
            </div>

            <div class="row">
                <div>
                    <label>Doctor</label>
                    <select th:field="*{doctor}">
                        <option value="">-- No Doctor --</option>
                        <option th:each="d : ${doctors}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div>
                    <label>Nurse</label>
                    <select th:field="*{nurse}">
                        <option value="">-- No Nurse --</option>
                        <option th:each="n : ${nurses}" th:value="${n.id}" th:text="${n.name}"></option>
                    </select>
                </div>
            </div>

            <div style="margin-top:10px">
                <button class="btn btn-success" type="submit">Save Appointment</button>
            </div>
        </form>
    </div>
</div>

<script>
    async function onPatientSelect() {
        const pId = document.getElementById('pId').value;
        if (!pId) return;
        try {
            const res = await fetch('/api/patients/' + pId);
            if (res.ok) {
                const data = await res.json();
                if (data.departmentId) {
                    document.getElementById('dId').value = data.departmentId;
                }
            }
        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>