<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Appointment Form</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body>
<div class="wrap">
    <div class="topbar">
        <a class="back" th:href="@{/appointments}">‚Üê Back</a>
        <div class="hx">
            <div class="pill a">üìÖ</div>
            <h1 th:text="${appointment.id} != null ? 'Edit Appointment' : 'New Appointment'">New Appointment</h1>
        </div>
    </div>

    <div class="card">
        <form class="form"
              th:action="${appointment.id} != null ? @{/appointments/{id}(id=${appointment.id})} : @{/appointments}"
              th:object="${appointment}"
              method="post">

            <div class="row">
                <div>
                    <label>Department</label>
                    <select name="departmentId" th:field="*{departmentId}" required>
                        <option value="">-- Select Department --</option>
                        <option th:each="dep : ${departments}" th:value="${dep.id}" th:text="${dep.name}"></option>
                    </select>
                </div>
                <div>
                    <label>Patient</label>
                    <select name="patientId" th:field="*{patientId}" required>
                        <option value="">-- Select Patient --</option>
                        <option th:each="p : ${patients}" th:value="${p.id}" th:text="${p.name}"></option>
                    </select>
                    <div id="roomInfo" class="back" style="margin-top:6px">Room: -</div>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Doctor</label>
                    <select th:field="*{doctorId}">
                        <option value="">-- No Doctor --</option>
                        <option th:each="d : ${doctors}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div>
                    <label>Nurse</label>
                    <select th:field="*{nurseId}">
                        <option value="">-- No Nurse --</option>
                        <option th:each="n : ${nurses}" th:value="${n.id}" th:text="${n.name}"></option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div>
                    <label>Admission Date</label>
                    <input type="date" th:field="*{admissionDate}" required>
                </div>
                <div>
                    <label>Status</label>
                    <select th:field="*{status}" required>
                        <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                    </select>
                </div>
            </div>

            <div>
                <button class="btn btn-success" type="submit" th:text="${appointment.id} != null ? 'Save' : 'Create'">Create</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const patientSelect = document.querySelector('select[name="patientId"]');
    const departmentSelect = document.querySelector('select[name="departmentId"]');
    const roomInfo = document.getElementById('roomInfo');

    async function onPatientChange() {
        const id = patientSelect.value;
        if (!id) { roomInfo.textContent = 'Room: -'; return; }
        try {
            const resp = await fetch('/api/patients/' + id);
            if (!resp.ok) return;
            const data = await resp.json();

            if (data.departmentId) {
                const opt = [...departmentSelect.options].find(o => o.value === data.departmentId);
                if (opt) departmentSelect.value = data.departmentId;
            }
            roomInfo.textContent = data.roomId ? ('Room: ' + data.roomId) : 'Room: -';
        } catch(e) {}
    }
    if (patientSelect) patientSelect.addEventListener('change', onPatientChange);
</script>
</body>
</html>